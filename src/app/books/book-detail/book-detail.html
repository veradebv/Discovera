<section class="bm-page bm-container">
  <button (click)="goBack()" class="bm-back">← Back to Discover</button>

  @let book = (book$ | async);
  @if (book) {
    <div class="bm-detail">
      <div class="bm-detail-header">
        <img
          src="{{ book.image || 'https://via.placeholder.com/220x320?text=No+Cover' }}"
          alt="{{ book.title }} cover"
          class="bm-detail-cover"
        />
        <div>
          <h2 class="bm-detail-title">{{ book.title }}</h2>
          <p class="bm-detail-author">{{ book.author }}</p>
          <p class="bm-detail-rating">★ {{ book.rating | number: '1.1-1' }}</p>
        </div>
      </div>

      <hr class="bm-divider" />

      <section class="bm-section">
        <h3>Reading Status</h3>
        <p class="bm-muted">Current: <strong>{{ book.status || 'Not specified' }}</strong></p>
        <div class="bm-filters">
          <button (click)="setStatus('want-to-read')" class="bm-chip">Want to Read</button>
          <button (click)="setStatus('reading')" class="bm-chip">Reading</button>
          <button (click)="setStatus('read')" class="bm-chip">Read</button>
        </div>
      </section>

      <hr class="bm-divider" />

      <section class="bm-section">
        <h3>Reviews</h3>

        <div class="bm-review-form">
          <textarea
            [(ngModel)]="newReview"
            placeholder="Write your review..."
            rows="3"
            class="bm-input bm-textarea"
          ></textarea>
          <button (click)="addReview()" class="bm-primary">Submit Review</button>
        </div>

        @if (book.reviews.length) {
          <ul class="bm-review-list">
            @for (review of book.reviews; track review.createdAt; let reviewIndex = $index) {
              <li class="bm-review-item">
                <div class="bm-review-header">
                  <img
                    [src]="'https://ui-avatars.com/api/?name=' + review.reviewerName + '&background=7a5f3c&color=fff&size=40'"
                    [alt]="review.reviewerName"
                    class="bm-review-avatar"
                  />
                  <div>
                    <strong class="bm-review-name">{{ review.reviewerName }}</strong>
                    <div class="bm-review-date">{{ review.createdAt | date: 'medium' }}</div>
                  </div>
                  <button
                    (click)="deleteReview(book, reviewIndex)"
                    class="bm-delete"
                    title="Delete review"
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                  </button>
                </div>
                <p class="bm-review-text">{{ review.text }}</p>
              </li>
            }
          </ul>
        } @else {
          <p class="bm-empty">No reviews yet. Be the first to review!</p>
        }
      </section>
    </div>
  } @else {
    <p class="bm-empty">Book not found.</p>
  }
</section>
